cubes:
  - name: financial_metrics
    sql_table: public.financial_metrics
    data_source: default

    joins:
      - name: daily_reports
        sql: "{CUBE}.report_id = {daily_reports}.report_id"
        relationship: many_to_one

    dimensions:
      - name: metric_id
        sql: metric_id
        type: number
        primary_key: true

      - name: created_at
        sql: created_at
        type: time

    measures:
      - name: count
        type: count

      - name: bank_inflow
        sql: bank_inflow
        type: sum

      - name: bank_outflow
        sql: bank_outflow
        type: sum

      - name: cash_balance
        sql: cash_balance
        type: avg

      - name: debt_ratio
        sql: debt_ratio
        type: avg

      - name: management_cost
        sql: management_cost
        type: sum

      - name: energy_cost
        sql: energy_cost
        type: sum

      - name: labor_cost_cut
        sql: labor_cost_cut
        type: sum

      - name: labor_cost_aseptic
        sql: labor_cost_aseptic
        type: sum

      - name: material_cost
        sql: material_cost
        type: sum

      - name: bank_inflow_2
        sql: bank_inflow_2
        type: sum

      - name: bank_outflow_2
        sql: bank_outflow_2
        type: sum

      - name: cash_balance_2
        sql: cash_balance_2
        type: avg

      - name: material_cost_2
        sql: material_cost_2
        type: sum

      - name: bank_inflow_3
        sql: bank_inflow_3
        type: sum

      - name: bank_outflow_3
        sql: bank_outflow_3
        type: sum

      - name: cash_balance_3
        sql: cash_balance_3
        type: avg

      - name: labor_cost
        sql: labor_cost
        type: sum

      - name: leaf_revenue
        sql: leaf_revenue
        type: sum

      - name: seedling_revenue
        sql: seedling_revenue
        type: sum

      - name: fertilizer_cost
        sql: fertilizer_cost
        type: sum

      - name: material_cost_3
        sql: material_cost_3
        type: sum

    pre_aggregations:
      - name: daily_financial_summary
        measures:
          - bank_inflow
          - bank_outflow
          - cash_balance
          - energy_cost
          - labor_cost
          - material_cost
        time_dimension: daily_reports.report_date
        granularity: day
        refresh_key:
          every: "30 minutes"
          
      - name: weekly_financial_trends
        measures:
          - bank_inflow
          - bank_outflow
          - cash_balance
          - debt_ratio
          - management_cost
          - energy_cost
          - labor_cost
          - material_cost
        time_dimension: daily_reports.report_date
        granularity: week
        refresh_key:
          every: "2 hours"
          
      - name: monthly_financial_rollup
        measures:
          - bank_inflow
          - bank_outflow
          - cash_balance
          - debt_ratio
          - management_cost
          - energy_cost
          - labor_cost
          - material_cost
          - leaf_revenue
          - seedling_revenue
          - fertilizer_cost
        time_dimension: daily_reports.report_date
        granularity: month
        refresh_key:
          every: "1 day"
          
      - name: financial_kpis_realtime
        measures:
          - cash_balance
          - debt_ratio
          - bank_inflow
          - bank_outflow
        time_dimension: daily_reports.report_date
        granularity: day
        refresh_key:
          every: "15 minutes"

